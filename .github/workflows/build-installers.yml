name: Build Installers

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build Next.js app
        run: npm run build
      
      - name: Build Windows installer
        run: npm run electron:build -- --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/*.exe
            dist/*.exe.blockmap
          retention-days: 30
      
      - name: Calculate checksums
        run: |
          cd dist
          Get-FileHash *.exe -Algorithm SHA256 | Format-List > checksums-windows.txt
      
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums-windows
          path: dist/checksums-windows.txt

  build-linux:
    name: Build Linux Installers
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxtst-dev libpng-dev
      
      - name: Install dependencies
        run: npm install
      
      - name: Build Next.js app
        run: npm run build
      
      - name: Build Linux installers
        run: npm run electron:build -- --linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: dist/*.AppImage
          retention-days: 30
      
      - name: Upload DEB package
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: dist/*.deb
          retention-days: 30
      
      - name: Calculate checksums
        run: |
          cd dist
          sha256sum *.AppImage *.deb > checksums-linux.txt
      
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums-linux
          path: dist/checksums-linux.txt
  
  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build Next.js app
        run: npm run build
      
      - name: Build macOS installer
        run: npm run electron:build -- --mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg
          retention-days: 30
      
      - name: Calculate checksums
        run: |
          cd dist
          shasum -a 256 *.dmg > checksums-macos.txt
      
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums-macos
          path: dist/checksums-macos.txt

  test-installers:
    name: Test Installers
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          find artifacts -type f -exec ls -lh {} \;
      
      - name: Verify checksums
        run: |
          echo "=== Checksums ==="
          find artifacts -name "checksums-*.txt" -exec cat {} \;
      
      - name: Generate summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Windows" >> $GITHUB_STEP_SUMMARY
          find artifacts/windows-installer -type f -name "*.exe" -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY || echo "- No Windows installer found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux" >> $GITHUB_STEP_SUMMARY
          find artifacts/linux-appimage -type f -name "*.AppImage" -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY || echo "- No AppImage found" >> $GITHUB_STEP_SUMMARY
          find artifacts/linux-deb -type f -name "*.deb" -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY || echo "- No DEB package found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS" >> $GITHUB_STEP_SUMMARY
          find artifacts/macos-dmg -type f -name "*.dmg" -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY || echo "- No DMG found" >> $GITHUB_STEP_SUMMARY

  create-release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos, test-installers]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/windows-installer/*.exe
            artifacts/linux-appimage/*.AppImage
            artifacts/linux-deb/*.deb
            artifacts/macos-dmg/*.dmg
            artifacts/checksums-*/*.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
